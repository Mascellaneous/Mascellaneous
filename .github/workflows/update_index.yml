name: Update Index and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'Econ/PastPaper/**/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === 1. Notify Google Sheets ===
      - name: Notify Google Sheets for Changed Files
        env:
          GAS_URL: "https://script.google.com/macros/s/AKfycbwpiS1BSv_qaCTmkdxyiSMwbGUojXFug-DIVIxeyUSMnUMz8lAZtM9CqM-beuEJt6IM/exec"
          SECRET_KEY: ${{ secrets.ACTION_KEY }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep "Econ/PastPaper/.*\.html" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No HTML files changed in the user commit. Skipping Google Sheet update."
            # We do NOT exit here, so the index generation still runs on manual dispatch
          else
            echo "Found changed files:"
            echo "$CHANGED_FILES"

            for file in $CHANGED_FILES; do
              filename=$(basename "$file")
              uniqueId="${filename%.*}"
              
              if [ "$uniqueId" == "index" ]; then
                continue
              fi

              echo "Updating Sheet for ID: $uniqueId"
              
              response=$(curl -s -L -G "${GAS_URL}" \
                --data-urlencode "action=update_deploy_status" \
                --data-urlencode "secret=${SECRET_KEY}" \
                --data-urlencode "uniqueId=${uniqueId}")
              
              echo "Response: $response"
            done
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # === 2. Remove Broken Polyfill Links (Fixes Console Error) ===
      - name: Remove Polyfill.io Links
        working-directory: ./Econ/PastPaper
        run: |
          echo "Removing broken polyfill.io links from HTML files..."
          # This finds all HTML files and deletes lines containing 'polyfill'
          find . -type f -name "*.html" -exec sed -i '/polyfill/d' {} +
          echo "Polyfill links removed."

      # === 3. Run generation script ===
      - name: Run generation script
        working-directory: ./Econ/PastPaper
        run: python generate_index.py

      # === 4. Inject Protection into ALL HTML Files ===
      - name: Inject Protection Script
        working-directory: ./Econ/PastPaper
        run: |
          PROTECT_JS="https://mas-repo.github.io/econ-database/projects/protect.js"
          SCRIPT_TAG="<script src=\"$PROTECT_JS\"></script>"
          
          echo "Starting injection process..."

          find . -type f -name "*.html" | while read file; do
            # Check generically for 'protect.js' to avoid duplicates
            if ! grep -q "protect.js" "$file"; then
              echo "Protecting: $file"
              echo "" >> "$file"
              echo "$SCRIPT_TAG" >> "$file"
            else
              echo "Skipping: $file (Already protected)"
            fi
          done

      # === 5. Commit and Push ALL changes ===
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generate index, remove polyfill, and protect files"
          # This pattern ensures we pick up the index AND the modified past papers
          file_pattern: "Econ/PastPaper/**/*.html"