name: Update Index and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'Econ/PastPaper/**/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === 1. Notify Google Sheets ===
      - name: Notify Google Sheets for Changed Files
        env:
          GAS_URL: "https://script.google.com/macros/s/AKfycbwpiS1BSv_qaCTmkdxyiSMwbGUojXFug-DIVIxeyUSMnUMz8lAZtM9CqM-beuEJt6IM/exec"
          SECRET_KEY: ${{ secrets.ACTION_KEY }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep "Econ/PastPaper/.*\.html" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No HTML files changed in the user commit."
          else
            echo "Found changed files:"
            echo "$CHANGED_FILES"

            for file in $CHANGED_FILES; do
              filename=$(basename "$file")
              uniqueId="${filename%.*}"
              if [ "$uniqueId" == "index" ]; then continue; fi

              echo "Updating Sheet for ID: $uniqueId"
              curl -s -L -G "${GAS_URL}" \
                --data-urlencode "action=update_deploy_status" \
                --data-urlencode "secret=${SECRET_KEY}" \
                --data-urlencode "uniqueId=${uniqueId}"
            done
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # === 2. Remove Broken Polyfill Links ===
      - name: Remove Polyfill.io Links
        working-directory: ./Econ/PastPaper
        run: |
          echo "Removing broken polyfill.io links..."
          find . -type f -name "*.html" -exec sed -i '/polyfill/d' {} +

      # === 3. Run generation script ===
      - name: Run generation script
        working-directory: ./Econ/PastPaper
        run: python generate_index.py

      # === 4. Inject Protection into ALL HTML Files ===
      - name: Inject Protection Script
        working-directory: ./Econ/PastPaper
        run: |
          PROTECT_JS="https://mas-repo.github.io/econ-database/projects/protect.js"
          # We define the script tag
          SCRIPT_TAG="<script src=\"$PROTECT_JS\"></script>"
          
          echo "Starting injection process..."

          find . -type f -name "*.html" | while read file; do
            # STRICT CHECK: Only inject if 'protect.js' is NOT found
            if grep -Fq "protect.js" "$file"; then
              echo "Skipping: $file (Already protected)"
            else
              echo "Protecting: $file"
              
              # FIX: Inject AFTER the opening <head> tag
              # This ensures valid HTML and that document.head exists (mostly)
              # If <head> is not found (rare), it falls back to Line 1
              if grep -q "<head>" "$file"; then
                sed -i "s|<head>|<head>$SCRIPT_TAG|i" "$file"
              else
                # Fallback for files without <head> tag
                sed -i "1i $SCRIPT_TAG" "$file"
              fi
            fi
          done

      # === 5. Commit and Push ALL changes ===
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generate index, remove polyfill, and protect files"
          file_pattern: "Econ/PastPaper/**/*.html"