name: Update Index and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'Econ/PastPaper/**/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === 1. Notify Google Sheets (Kept exactly as your original) ===
      - name: Notify Google Sheets for Changed Files
        env:
          GAS_URL: "https://script.google.com/macros/s/AKfycbwKrBf3nRkltBs0M_8SHc0uBgQ2fF58ZFKf_UBhaipK3zn_Hd07hJuAiBCdi9u__9z0/exec"
          SECRET_KEY: ${{ secrets.ACTION_KEY }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep "Econ/PastPaper/.*\.html" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No HTML files changed in the user commit. Skipping Google Sheet update."
            exit 0
          fi

          echo "Found changed files:"
          echo "$CHANGED_FILES"

          for file in $CHANGED_FILES; do
            filename=$(basename "$file")
            uniqueId="${filename%.*}"
            
            if [ "$uniqueId" == "index" ]; then
              continue
            fi

            echo "Updating Sheet for ID: $uniqueId"
            
            response=$(curl -s -L -G "${GAS_URL}" \
              --data-urlencode "action=update_deploy_status" \
              --data-urlencode "secret=${SECRET_KEY}" \
              --data-urlencode "uniqueId=${uniqueId}")
            
            echo "Response: $response"
          done

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # === 2. Run the original generation script ===
      - name: Run generation script
        working-directory: ./Econ/PastPaper
        run: python generate_index.py

      # === 3. NEW STEP: Inject Auth Bridge into the generated index.html ===
      - name: Inject Auth Bridge Protection
        working-directory: ./Econ/PastPaper
        env:
          # REPLACE THIS with your main website URL (where auth-bridge.html is located)
          # Example: https://your-main-db-site.com
          MAIN_SITE_URL: "https://mas-repo.github.io/econ-database/" 
        run: |
          python -c "
          import re
          import os

          file_path = 'index.html'
          bridge_url = os.environ['MAIN_SITE_URL'] + '/auth-bridge.html'

          # 1. Read the content generated by generate_index.py
          if not os.path.exists(file_path):
              print('Error: index.html was not found.')
              exit(1)

          with open(file_path, 'r', encoding='utf-8') as f:
              original_html = f.read()

          # 2. Extract the body content (the list of papers)
          # We look for everything between <body> and </body>
          body_match = re.search(r'<body[^>]*>(.*?)</body>', original_html, re.DOTALL | re.IGNORECASE)
          
          if body_match:
              content_to_protect = body_match.group(1)
          else:
              # Fallback: just use the whole file if structure is weird
              content_to_protect = original_html

          # 3. Define the Secure Template
          # This wraps the content in the Auth Bridge logic
          new_html = f'''<!DOCTYPE html>
          <html lang=\"en\">
          <head>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <title>DSE Past Paper Index (Protected)</title>
              <style>
                  body {{ font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #2c3e50; }}
                  .container {{ max-width: 800px; margin: 0 auto; }}
                  
                  /* States */
                  #loading-state {{ text-align: center; padding-top: 50px; }}
                  #denied-state {{ display: none; text-align: center; padding-top: 50px; }}
                  #protected-content {{ display: none; }} /* Hidden by default */
                  
                  /* UI Elements */
                  .card {{ background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }}
                  .btn {{ display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; margin-top: 15px; }}
                  .spinner {{ width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }}
                  @keyframes spin {{ 0% {{ transform: rotate(0deg); }} 100% {{ transform: rotate(360deg); }} }}
                  
                  /* Style the injected content slightly */
                  #injected-list ul {{ list-style: none; padding: 0; }}
                  #injected-list li {{ padding: 10px 0; border-bottom: 1px solid #eee; }}
                  #injected-list a {{ color: #2980b9; text-decoration: none; }}
                  #injected-list a:hover {{ text-decoration: underline; }}
              </style>
          </head>
          <body>
              <div class=\"container\">
                  
                  <!-- Loading -->
                  <div id=\"loading-state\">
                      <div class=\"spinner\"></div>
                      <h3>Verifying Access...</h3>
                  </div>

                  <!-- Denied -->
                  <div id=\"denied-state\">
                      <div class=\"card\">
                          <h2>ðŸ”’ Access Denied</h2>
                          <p>You must be logged into the Question Bank to view this index.</p>
                          <a href=\"{os.environ['MAIN_SITE_URL']}\" class=\"btn\">Go to Login</a>
                      </div>
                  </div>

                  <!-- Content -->
                  <div id=\"protected-content\">
                      <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;\">
                          <h1 style=\"margin:0;\">Past Paper Index</h1>
                          <span id=\"user-badge\" style=\"background:#e3f2fd; color:#1565c0; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold;\"></span>
                      </div>
                      
                      <div class=\"card\" id=\"injected-list\">
                          {content_to_protect}
                      </div>
                  </div>

              </div>

              <!-- The Bridge Iframe -->
              <iframe id=\"auth-bridge\" src=\"{bridge_url}\" style=\"display:none; width:0; height:0; border:0;\"></iframe>

              <script>
                  const authTimeout = setTimeout(() => {{
                      document.getElementById('loading-state').style.display = 'none';
                      document.getElementById('denied-state').style.display = 'block';
                  }}, 5000);

                  window.addEventListener('message', function(event) {{
                      // Optional: Check event.origin here for security
                      try {{
                          const data = JSON.parse(event.data);
                          if (data.status === 'authorized') {{
                              clearTimeout(authTimeout);
                              document.getElementById('loading-state').style.display = 'none';
                              document.getElementById('protected-content').style.display = 'block';
                              
                              const name = data.user.displayName || 'User';
                              document.getElementById('user-badge').textContent = 'ðŸ‘¤ ' + name;
                          }} else {{
                              clearTimeout(authTimeout);
                              document.getElementById('loading-state').style.display = 'none';
                              document.getElementById('denied-state').style.display = 'block';
                          }}
                      }} catch (e) {{}}
                  }});
              </script>
          </body>
          </html>'''

          # 4. Overwrite the file
          with open(file_path, 'w', encoding='utf-8') as f:
              f.write(new_html)
          
          print('Successfully injected Auth Bridge into index.html')
          "

      # === 4. Commit and Push ===
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generate index.html with Auth Protection"
          file_pattern: "Econ/PastPaper/index.html"