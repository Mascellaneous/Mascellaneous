name: Update Index and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'Econ/PastPaper/**/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === 1. Notify Google Sheets ===
      - name: Notify Google Sheets for Changed Files
        env:
          GAS_URL: "https://script.google.com/macros/s/AKfycbwpiS1BSv_qaCTmkdxyiSMwbGUojXFug-DIVIxeyUSMnUMz8lAZtM9CqM-beuEJt6IM/exec"
          SECRET_KEY: ${{ secrets.ACTION_KEY }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep "Econ/PastPaper/.*\.html" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No HTML files changed in the user commit. Skipping Google Sheet update."
            exit 0
          fi

          echo "Found changed files:"
          echo "$CHANGED_FILES"

          for file in $CHANGED_FILES; do
            filename=$(basename "$file")
            uniqueId="${filename%.*}"
            
            if [ "$uniqueId" == "index" ]; then
              continue
            fi

            echo "Updating Sheet for ID: $uniqueId"
            
            response=$(curl -s -L -G "${GAS_URL}" \
              --data-urlencode "action=update_deploy_status" \
              --data-urlencode "secret=${SECRET_KEY}" \
              --data-urlencode "uniqueId=${uniqueId}")
            
            echo "Response: $response"
          done

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # === 2. Run generation script ===
      - name: Run generation script
        working-directory: ./Econ/PastPaper
        run: python generate_index.py

      # === 3. Inject Protection into ALL HTML Files ===
      - name: Inject Protection Script
        working-directory: ./Econ/PastPaper
        run: |
          # The exact URL you want to inject
          PROTECT_JS="https://mas-repo.github.io/econ-database/projects/protect.js"
          SCRIPT_TAG="<script src=\"$PROTECT_JS\"></script>"
          
          echo "Starting injection process..."

          # Find all .html files in current folder and subfolders
          find . -type f -name "*.html" | while read file; do
            
            # FIX: We now grep for 'protect.js' generically to catch any path variation
            # This prevents adding it if 'projects/protect.js' OR 'js/protect.js' exists
            if ! grep -q "protect.js" "$file"; then
              echo "Protecting: $file"
              
              # Append a newline and then the script tag to the end of the file
              echo "" >> "$file"
              echo "$SCRIPT_TAG" >> "$file"
            else
              echo "Skipping: $file (Already protected)"
            fi
          done

      # === 4. Commit and Push ALL changes ===
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generate index and protect all HTML files"
          file_pattern: "Econ/PastPaper/**/*.html"